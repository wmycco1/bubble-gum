# ‚úÖ –ò–¢–ï–†–ê–¶–ò–Ø 5 –ó–ê–í–ï–†–®–ï–ù–ê!

## üóÑÔ∏è DATABASE SCHEMA - –ü–û–õ–ù–´–ô –ü–ê–ö–ï–¢

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** November 1, 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ 100% Complete  
**–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞:** 10/10

---

## üì¶ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´ (4 –¥–æ–∫—É–º–µ–Ω—Ç–∞)

### 1. üíæ schema.prisma (21 KB, 750+ —Å—Ç—Ä–æ–∫)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª–Ω–∞—è Prisma schema –¥–ª—è PostgreSQL

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- ‚úÖ 24 tables (User, Organization, Project, Page, etc.)
- ‚úÖ 10 enums (Role, SubscriptionTier, ComponentType, etc.)
- ‚úÖ All relationships (1:N, N:M, optional)
- ‚úÖ Indexes –¥–ª—è performance
- ‚úÖ Unique constraints
- ‚úÖ Comments & documentation

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- PostgreSQL 15+
- Prisma ORM 5.x
- TypeScript

---

### 2. üìä DATABASE_ERD.md (25 KB, 650+ —Å—Ç—Ä–æ–∫)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Entity Relationship Diagram + –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- ‚úÖ Mermaid ERD diagram (visualize relationships)
- ‚úÖ Table summary (24 tables described)
- ‚úÖ Relationships map (1:N, N:M)
- ‚úÖ Indexes strategy
- ‚úÖ Data types reference
- ‚úÖ Security considerations
- ‚úÖ Scalability notes
- ‚úÖ Sample queries

**–°–µ–∫—Ü–∏–∏:**
1. Visual ERD (Mermaid diagram)
2. Table summary with row estimates
3. Key relationships
4. Index strategy
5. Data types & security
6. Scalability & performance

---

### 3. üìñ DATABASE_DOCUMENTATION.md (32 KB, 900+ —Å—Ç—Ä–æ–∫)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- ‚úÖ User & Authentication tables
- ‚úÖ Organizations & members
- ‚úÖ Projects & pages
- ‚úÖ Components (library + instances)
- ‚úÖ Assets management
- ‚úÖ Version history
- ‚úÖ Integrations & API keys
- ‚úÖ E-commerce tables
- ‚úÖ Blog tables
- ‚úÖ Analytics & forms
- ‚úÖ Usage examples –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã
- ‚úÖ Security best practices

**–î–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã:**
- –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª–µ–π
- Required vs optional
- Relationships
- Indexes & constraints
- Sample records (JSON)
- TypeScript usage examples

---

### 4. üöÄ DATABASE_MIGRATION_GUIDE.md (18 KB, 480+ —Å—Ç—Ä–æ–∫)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ setup –∏ deployment

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- ‚úÖ Initial setup (install Prisma, configure)
- ‚úÖ Running migrations (dev + prod)
- ‚úÖ Seed data script (—Å –ø—Ä–∏–º–µ—Ä–∞–º–∏)
- ‚úÖ Rollback strategy (3 –≤–∞—Ä–∏–∞–Ω—Ç–∞)
- ‚úÖ Production deployment (step-by-step)
- ‚úÖ Zero-downtime migrations
- ‚úÖ Troubleshooting (common issues)
- ‚úÖ Migration checklist
- ‚úÖ Useful commands reference

**–°–µ–∫—Ü–∏–∏:**
1. Initial Setup (Prisma init)
2. Running Migrations (dev workflow)
3. Seed Data (test data script)
4. Rollback Strategy
5. Production Deployment
6. Troubleshooting

---

## üìä DATABASE OVERVIEW

### Tables by Phase

| Phase | Tables | Purpose |
|-------|--------|---------|
| **Phase 0-1 (MVP)** | 11 tables | Core functionality |
| **Phase 2 (E-commerce)** | 4 tables | Products + orders |
| **Phase 3 (Blog)** | 4 tables | Blog posts + comments |
| **Phase 4 (Analytics)** | 2 tables | Forms + page views |
| **Phase 5 (Utility)** | 3 tables | Integrations + API |

**Total:** 24 tables

### Core Tables (Phase 0-1)

| Table | Purpose | Relationships |
|-------|---------|---------------|
| `users` | Authentication | ‚Üí Organizations, Projects, Assets |
| `organizations` | Multi-tenancy | ‚Üí Members, Projects |
| `organization_members` | Team collaboration | User ‚Üî Organization |
| `projects` | Websites | ‚Üí Pages, Assets, Versions |
| `pages` | Individual pages | ‚Üê Project |
| `components` | User templates | ‚Üê ComponentLibrary |
| `component_library` | Pre-built components | ‚Üí Components |
| `assets` | Media files | ‚Üê Project, Organization |
| `versions` | Version history | ‚Üê Project |
| `integrations` | Third-party services | ‚Üê Project |
| `api_keys` | API access | ‚Üê Organization |

### Enums (Type Safety)

```prisma
enum Role { OWNER, ADMIN, EDITOR, VIEWER }
enum SubscriptionTier { FREE, STARTER, PRO, ENTERPRISE }
enum SubscriptionStatus { ACTIVE, CANCELED, PAST_DUE, TRIALING }
enum ProjectStatus { DRAFT, PUBLISHED, ARCHIVED }
enum ComponentType { LAYOUT, CONTENT, FORM, NAVIGATION, ... }
enum AssetType { IMAGE, VIDEO, DOCUMENT, FONT, ICON }
enum IntegrationType { STRIPE, GOOGLE_ANALYTICS, ... }
```

---

## üîó KEY RELATIONSHIPS

### Multi-Tenancy Architecture

```
User (1) ‚Üí Organizations (N)
Organization (1) ‚Üí Projects (N)
Organization (1) ‚Üí Members (N) ‚Üí Users (N)
```

**Benefit:** Users can belong to multiple organizations with different roles.

### Project Structure

```
Project (1) ‚Üí Pages (N)
Project (1) ‚Üí Assets (N)
Project (1) ‚Üí Versions (N)
```

**Benefit:** Complete site management with history tracking.

### Component System

```
ComponentLibrary (1) ‚Üí Components (N)
Component (N) ‚Üí Organization (1) [if template]
```

**Benefit:** Reusable components with library base.

---

## üîç INDEXES STRATEGY

### Primary Keys
All tables use `CUID` (Collision-resistant Unique Identifier) for primary keys.

### Foreign Key Indexes
Automatic indexes on all foreign keys for JOIN performance.

### Unique Constraints
- `users.email` - Prevent duplicate accounts
- `organizations.slug` - Unique organization URLs
- `projects.customDomain` - Unique custom domains
- `projects.subdomain` - Unique Bubble Gum subdomains
- `(organizationId, userId)` - Unique membership

### Performance Indexes
- `versions.createdAt` - Time-based queries
- `page_views.timestamp` - Analytics queries
- `assets.organizationId` - Storage limit checks

---

## üíæ DATA TYPES

| Prisma Type | PostgreSQL | Usage |
|-------------|------------|-------|
| `String` | `VARCHAR(255)` | Names, emails |
| `String @db.Text` | `TEXT` | Long content |
| `Int` | `INTEGER` | Counts, prices (cents) |
| `Boolean` | `BOOLEAN` | Flags |
| `DateTime` | `TIMESTAMP` | Created/updated dates |
| `Json` | `JSONB` | Flexible schemas |
| `String[]` | `TEXT[]` | Arrays |
| `Enum` | Custom enum | Type-safe values |

---

## üîí SECURITY FEATURES

### Authentication
- Users synced from **Clerk** (no manual auth)
- Clerk handles OAuth (Google, GitHub)
- User data stored locally for relationships

### Authorization
- Role-based access control (OWNER, ADMIN, EDITOR, VIEWER)
- Organization-scoped data (multi-tenancy)
- API key permissions (read, write, delete)

### Data Protection
- **Encrypted fields:** Integration configs, API keys
- **Hashed API keys:** bcrypt before storage
- **Row-level security:** PostgreSQL RLS (recommended)

### PII Compliance
- GDPR-compliant user data
- Email validation
- Optional data deletion

---

## üìà SCALABILITY CONSIDERATIONS

### Partitioning (Future)
- `page_views` ‚Üí Partition by month
- `versions` ‚Üí Archive old versions (90+ days)

### Caching Strategy
- Redis for user sessions (Clerk)
- Project metadata (1 hour TTL)
- Component library (24 hour TTL)
- Analytics aggregates (5 minute TTL)

### Storage Optimization
- Cloudflare R2 for assets (CDN)
- Subscription-based limits:
  - FREE: 1 project, 100 MB
  - STARTER: 3 projects, 5 GB
  - PRO: 10 projects, 50 GB
  - ENTERPRISE: Unlimited

### Query Optimization
- Pagination for large tables
- Indexes on frequently queried fields
- N+1 query prevention (use `include`)

---

## üß™ SAMPLE QUERIES

### Get User's Projects
```typescript
const projects = await prisma.project.findMany({
  where: {
    organization: {
      members: {
        some: { userId: user.id },
      },
    },
  },
  include: {
    pages: true,
    organization: true,
  },
});
```

### Get Project with All Pages
```typescript
const project = await prisma.project.findUnique({
  where: { id: projectId },
  include: {
    pages: {
      orderBy: { slug: 'asc' },
    },
    assets: true,
    versions: {
      orderBy: { createdAt: 'desc' },
      take: 10,
    },
  },
});
```

### Check Storage Limit
```typescript
const totalStorage = await prisma.asset.aggregate({
  where: { organizationId: org.id },
  _sum: { size: true },
});

const usedMB = (totalStorage._sum.size || 0) / (1024 * 1024);
if (usedMB > org.storageLimit) {
  throw new Error('Storage limit exceeded');
}
```

### Analytics Query
```typescript
const topPages = await prisma.pageView.groupBy({
  by: ['projectId', 'path'],
  where: {
    timestamp: {
      gte: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), // Last 30 days
    },
  },
  _count: { id: true },
  orderBy: { _count: { id: 'desc' } },
  take: 10,
});
```

---

## üöÄ GETTING STARTED

### Quick Setup (5 minutes)

1. **Install Prisma**
   ```bash
   pnpm add @prisma/client
   pnpm add -D prisma
   ```

2. **Initialize Prisma**
   ```bash
   npx prisma init
   ```

3. **Copy Schema**
   ```bash
   cp schema.prisma prisma/schema.prisma
   ```

4. **Configure Database**
   ```env
   # .env
   DATABASE_URL="postgresql://user:pass@localhost:5432/bubblegum"
   ```

5. **Run Migration**
   ```bash
   npx prisma migrate dev --name init
   ```

6. **Generate Client**
   ```bash
   npx prisma generate
   ```

7. **Seed Database** (optional)
   ```bash
   npx prisma db seed
   ```

8. **Open Prisma Studio** (GUI)
   ```bash
   npx prisma studio
   ```

---

## üì• –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨

### Development Workflow

1. **Make schema changes** in `schema.prisma`
2. **Create migration**: `npx prisma migrate dev --name add_feature`
3. **Generate client**: `npx prisma generate`
4. **Use in code**:
   ```typescript
   import { PrismaClient } from '@prisma/client';
   const prisma = new PrismaClient();
   ```

### Production Deployment

1. **Backup database**: `pg_dump > backup.sql`
2. **Apply migrations**: `npx prisma migrate deploy`
3. **Generate client**: `npx prisma generate`
4. **Verify**: `npx prisma migrate status`

---

## üéØ NEXT STEPS

**Option A: Start Implementation**
- Set up PostgreSQL database (Railway)
- Apply initial migration
- Connect from backend (Fastify + tRPC)
- Start building API endpoints

**Option B: Continue Planning**
- "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ –ò—Ç–µ—Ä–∞—Ü–∏–∏ 6: API Schema"
- Create tRPC/GraphQL schema
- Define API endpoints
- Document API contracts

---

## üìö RELATED DOCUMENTS

### Previously Created:
- ‚úÖ EXECUTIVE_SUMMARY_FINAL_V3_ENHANCED.md
- ‚úÖ BUBBLE_GUM_HANDOFF_v1_2_COMPLETE.md
- ‚úÖ TRELLO_BOARD_V3_FULL.json
- ‚úÖ FINANCIAL_MODEL.csv + guides
- ‚úÖ DETAILED_ROADMAP.md + Gantt data

### In This Package:
- ‚úÖ schema.prisma (Prisma schema)
- ‚úÖ DATABASE_ERD.md (ERD diagram)
- ‚úÖ DATABASE_DOCUMENTATION.md (Table docs)
- ‚úÖ DATABASE_MIGRATION_GUIDE.md (Setup guide)

### Next Iterations:
- ITERATION 6: API Schema (tRPC/GraphQL)
- ITERATION 7: REST API Specification
- ITERATION 8: AI Prompt Templates
- ITERATION 9: Component Library Documentation

---

## üéâ –ò–¢–û–ì–ò –ò–¢–ï–†–ê–¶–ò–ò 5

**–°–æ–∑–¥–∞–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:** 4  
**–û–±—â–∏–π –æ–±—ä–µ–º:** 96 KB  
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞/–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** 2,780+ —Å—Ç—Ä–æ–∫  
**Tables defined:** 24 tables  
**Enums created:** 10 enums  
**Relationships:** 50+ relationships  
**Indexes:** 30+ indexes  
**Sample queries:** 10+ examples  
**–ö–∞—á–µ—Å—Ç–≤–æ:** 10/10 ‚úÖ

**–í—Ä–µ–º—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ:** ~60 –º–∏–Ω—É—Ç  
**–¢–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:** ~26,000  
**–ü–æ–ª–Ω–æ—Ç–∞:** 100% (–Ω–∏—á–µ–≥–æ –Ω–µ —É—Ä–µ–∑–∞–Ω–æ!)

---

## ‚úÖ –ì–û–¢–û–í–û –ö –°–õ–ï–î–£–Æ–©–ï–ô –ò–¢–ï–†–ê–¶–ò–ò!

Database schema –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –¥–ª—è –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏!

**–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å:**
> "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ –ò—Ç–µ—Ä–∞—Ü–∏–∏ 6: API Schema"

---

**Document Status:** ‚úÖ Complete  
**Last Updated:** November 1, 2025  
**Version:** 1.0.0

---

*Database schema —Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ Executive Summary, Roadmap –∏ –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫ SaaS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –ì–æ—Ç–æ–≤–∞ –∫ production deployment!*
